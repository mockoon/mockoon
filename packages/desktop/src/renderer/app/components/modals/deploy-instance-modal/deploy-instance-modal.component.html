<ng-container
  *ngIf="{
    user: user$ | async,
    taskInProgress: taskInProgress$ | async,
    environment: environment$ | async,
    instanceExists: instanceExists$ | async
  } as data"
>
  <div class="modal-header">
    <h3 class="modal-title">
      {{ data.instanceExists ? 'Re-deploy' : 'Deploy' }} "{{
        data.environment?.name
      }}"
      <br />
      <small class="text-muted h6">Configure your cloud instance:</small>
    </h3>
  </div>

  <div class="modal-body">
    <div [formGroup]="optionsForm">
      <div class="mb-3">
        <div class="input-group align-items-center">
          <label class="col-form-label pe-2" for="subdomain">Subdomain</label>
          <div class="col-4">
            <input
              type="text"
              id="subdomain"
              class="form-control"
              formControlName="subdomain"
              placeholder="Optional custom subdomain"
              [maxLength]="50"
              [minLength]="5"
            />
          </div>
          <div class="input-group-text">
            <app-svg
              icon="info"
              ngbTooltip="Customize the subdomain of your instance (e.g. {subdomain}.mockoon.app). Leave empty to use a random subdomain. Only letters, numbers, and dashes are allowed."
            ></app-svg>
          </div>
          <div class="input-group-text text-warning">
            <small>
              @if (
                optionsForm.get('subdomain').errors?.minlength ||
                optionsForm.get('subdomain').errors?.maxlength ||
                optionsForm.get('subdomain').errors?.pattern
              ) {
                5 to 50 characters, a-z, 0-9 and - (not at the beginning or end)
              } @else if (optionsForm.get('subdomain').errors?.subdomainTaken) {
                This subdomain is not available
              } @else if (
                optionsForm.get('subdomain').value &&
                !optionsForm.get('subdomain').errors &&
                !data.taskInProgress
              ) {
                <app-svg icon="check" size="12" class="text-success"></app-svg>
              }
            </small>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <div class="input-group align-items-center">
          <label class="col-form-label pe-2">Instance visibility</label>
          <app-toggle
            prefix="instance-visibility"
            formControlName="visibility"
            [items]="visibilityToggle"
            [uncheckable]="false"
          ></app-toggle>
          <div class="input-group-text">
            <app-svg
              icon="info"
              ngbTooltip="Public instances are accessible by anyone with the URL. Private instances are only accessible by you and your team members using a token."
            ></app-svg>
          </div>
        </div>
      </div>

      <div class="">
        <div class="input-group align-items-center">
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              id="enableAdminApi"
              formControlName="enableAdminApi"
            />
            <label class="form-check-label" for="enableAdminApi">
              Enable admin API
            </label>
          </div>
          <div class="input-group-text">
            <app-svg
              icon="info"
              ngbTooltip="Enable the admin API exposed on /mockoon-admin endpoint. This API allows you to manage your mocks remotely."
            ></app-svg>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer justify-content-space-between">
    <div
      *ngIf="data.user && data.user.plan !== 'FREE'"
      class="col-6 d-flex align-items-center"
    >
      <p
        class="mb-0"
        [ngClass]="{
          'text-warning':
            data.user?.deployInstancesQuotaUsed >=
            data.user?.deployInstancesQuota
        }"
      >
        Quota used ({{ data.user?.deployInstancesQuotaUsed }}/{{
          data.user?.deployInstancesQuota
        }})
      </p>
      <a
        class="btn btn-link btn-icon text-primary ps-2"
        href="{{ accountUrl }}"
        target="_blank"
      >
        My account
        <app-svg icon="open_in_new" class="ps-1" size="12"></app-svg>
      </a>
    </div>
    <div class="ms-auto d-flex align-items-center">
      @if (data.taskInProgress) {
        <div class="d-inline-block me-2">
          <app-spinner></app-spinner>
        </div>
      }

      <button
        type="button"
        class="btn btn-primary me-2"
        (click)="deploy(data.user, data.environment.uuid)"
        [disabled]="data.taskInProgress || optionsForm.invalid"
      >
        {{ data.instanceExists ? 'Re-deploy' : 'Deploy' }}
      </button>

      @if (data.instanceExists) {
        <button
          type="button"
          class="btn btn-danger me-2"
          (click)="deleteInstance(data.environment.uuid)"
          [disabled]="data.taskInProgress"
        >
          Delete
        </button>
      }

      <button
        type="button"
        class="btn btn-secondary modal-close"
        (click)="close()"
      >
        Cancel
      </button>
    </div>
  </div>
</ng-container>
